# Risk Metrics: Value at Risk (VaR) and Expected Shortfall (ES) for Portfolios of European Options

This script calculates the Value at Risk (VaR) and Expected Shortfall (ES) of a portfolio of European options (calls and puts) using pricing models and price simulation under the Black-Scholes dynamics.

# Theory: VaR and ES Explained Step by Step

## 1. What is Value at Risk (VaR)?
**Value at Risk (VaR)** is a risk measure that estimates the maximum potential loss of a portfolio over a specific time horizon and at a given confidence level.

- Example: A 1-day 99% VaR of 100.000€ means there is a 1% probability of losing more than 100.000€ in one day.

**Mathematical Definition:**

$$
\mathrm{VaR}_{\alpha}(L) = \inf \{ l \in \mathbb{R} : P(L > l) \leq 1-\alpha \}
$$

where $L$ is the portfolio loss and $\alpha$ is the confidence level.

## 2. What is Expected Shortfall (ES) or Conditional VaR?
**Expected Shortfall (ES)** is the average loss in the worst cases, i.e., when the loss exceeds the VaR. It is a coherent risk measure and better captures tail risk.

**Mathematical Definition:**

$$
\mathrm{ES}_{\alpha}(L) = \mathbb{E}[L \mid L > \mathrm{VaR}_{\alpha}(L)]
$$

## 3. How are VaR and ES calculated in practice?
- The distribution of portfolio profit and loss (P&L) is simulated under future scenarios.
- VaR is computed as the corresponding percentile of the P&L distribution.
- ES is the mean of losses exceeding the VaR.

## 4. Why is the time horizon important?
- VaR/ES always refers to a specific horizon (e.g., 1 day, 10 days).
- For derivatives, the value of options depends on time to maturity, so in simulated scenarios, the horizon must be subtracted from the real maturity.

## 5. Why use simulation?
- For derivative portfolios, the P&L distribution is neither normal nor symmetric.
- Simulation captures non-linearity and the effect of time decay (theta decay).

## 6. Graphical Interpretation
- VaR is the left-tail percentile of the P&L histogram.
- ES is the mean of the most extreme losses (beyond VaR).

# Script Logic: Step by Step

1. **Portfolio Definition**
   - The portfolio is defined manually as a list of options, each with ticker, type (call/put), strike, time to maturity (T, in years), and number of contracts.
   - Example:
     ```python
     portfolio = [
         {'ticker': '^SPX','type': 'call','K': 5955,'T': 0.0712,'contracts': 15},
         {'ticker': '^SPX','type': 'put','K': 5960,'T': 0.0712,'contracts': 10},
     ]
     ```

2. **Download of Prices and Calculation of Historical Volatility**
   - Historical prices for each underlying are downloaded using yfinance.
   - Annualized historical volatility is computed for each underlying.

3. **Implied Volatility Calculation**
   - The user may input the market price of each option.
   - Implied volatility is calculated using the Black-Scholes model.
   - If not provided, historical volatility is used.

4. **Simulation of Future Prices (GBM)**
   - N scenarios of future underlying prices are simulated using Geometric Brownian Motion (GBM) for a defined horizon (e.g., 1 day: `HORIZON_VAR = 1/252`).

5. **Valuation of the Portfolio in Simulated Scenarios**
   - For each scenario and pricing model (Black-Scholes, Binomial, Monte Carlo, Finite Differences), the portfolio is valued:
     - The current value (V₀) is calculated using the real maturity of each option.
     - In each scenario, the time to maturity is `T_future = max(opt['T'] - HORIZON_VAR, 0)`.

6. **Calculation of P&L, VaR, and ES**
   - P&L is computed as the difference between the simulated and current portfolio value.
   - VaR is the left-tail percentile of the P&L distribution (e.g., 1% for 99% VaR).
   - ES is the mean of losses exceeding the VaR.

7. **Visualization of Results**
   - Histograms of simulated P&L are plotted, marking VaR and ES for each model.
   - The distribution of simulated prices and log-prices is also plotted to validate the simulation.

# Visualizations Generated by the Script

The script automatically produces several visualizations to facilitate risk analysis and simulation validation:

### 1. Histogram of Simulated P&L with VaR and ES
- For each pricing model (Black-Scholes, Binomial, Monte Carlo, Finite Differences), the histogram of simulated portfolio P&L is plotted.
- VaR (red dashed line) and ES (orange dashed line) are marked on the histogram.
- Output file: `risk_metrics_results.png`

### 2. Histogram of Delta-Hedged P&L
- The histogram of P&L for the portfolio assuming static delta hedging is plotted.
- Allows comparison of residual risk after neutralizing directional exposure.
- Output file: `risk_metrics_results_delta_hedge.png`

### 3. Distribution of Simulated Prices
- For each underlying, the distribution of simulated prices at the VaR/ES horizon is plotted.
- Validates the simulation under the Geometric Brownian Motion (GBM) model.
- Output file: `simulated_prices_distribution.png`

### 4. Distribution of Simulated Log-Prices
- The distribution of the logarithm of simulated prices is plotted, which should approximate a normal distribution under GBM.
- Output file: `simulated_logprices_distribution.png`

#### Example Plots
- ![Simulated P&L Histogram](risk_metrics_results.png)
- ![Delta-Hedged P&L Histogram](risk_metrics_results_delta_hedge.png)
- ![Simulated Prices Distribution](simulated_prices_distribution.png)
- ![Simulated Log-Prices Distribution](simulated_logprices_distribution.png)

Each plot helps visually interpret the portfolio's risk profile and the validity of the simulation. It is recommended to review especially the P&L and delta-hedged histograms to understand the impact of hedging and residual risk exposure.

# Delta Hedging and Delta-Hedged VaR/ES

## Total Delta Calculation
The script calculates the **total portfolio delta** using the Black-Scholes formula for each option (weighted by contracts). This provides the portfolio's sensitivity to movements in the underlying asset.

## Simulation of Delta-Hedged VaR/ES
- The P&L of the portfolio is simulated assuming a static delta hedge at the start of the simulation horizon.
- In each scenario, the change in the underlying is multiplied by the initial total delta, simulating hedging with the underlying asset.
- VaR and Expected Shortfall (ES) of the delta-hedged portfolio are calculated and visualized for each pricing model.
- Output file: `risk_metrics_results_delta_hedge.png`.

## Interpretation and Warnings
- **Delta hedging is most relevant and effective for portfolios with ATM or ITM options**, where delta is significant. For portfolios with OTM options, delta is low and the hedge has little impact.
- **Under normal conditions**, the delta-hedged VaR/ES should be smaller in magnitude (less negative) than the original VaR/ES, as directional spot risk is eliminated.
- **In extreme volatility scenarios, negative gamma, or very large spot moves**, the delta-hedged VaR/ES may be more negative than the original. The script warns about this behavior and recommends reviewing the portfolio composition and simulation parameters.

## Example Output
```
Total portfolio delta (Black-Scholes): 2.0936

--- VaR and ES for the delta-hedged portfolio (neutralized to initial spot) ---
Model: black_scholes
  Value at Risk (VaR) delta-hedged at 99.0%: -3542.53
  Expected Shortfall (ES) delta-hedged at 99.0%: -3698.83
...
```

## Usage Recommendations
- To analyze the real effect of delta hedging, test with portfolios including ATM or ITM options and realistic volatilities.
- If the delta-hedged VaR/ES is more negative than the original, review volatility, simulation horizon, and portfolio composition.

---

**References:**
- Jorion, P. (2007). Value at Risk: The New Benchmark for Managing Financial Risk.
- Hull, J. (2018). Risk Management and Financial Institutions.
